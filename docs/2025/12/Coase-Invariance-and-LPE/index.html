<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Paul Kelleher">
<meta name="dcterms.date" content="2025-12-04">

<title>Coase, Invariance, and LPE – PK blog</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 1em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../">
<script src="../../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../site_libs/bootstrap/bootstrap-180c2da0a670722e004eef55ee384cc3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed slimcontent quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../index.html">
    <span class="navbar-title">J. Paul Kelleher</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="https://paulkelleher.net/about/"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://paulkelleher.net/research/"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://paulkelleher.net/book/"> 
<span class="menu-text">Book</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../"> 
<span class="menu-text">Blog</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Coase, Invariance, and LPE</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#a-coasean-error" id="toc-a-coasean-error" class="nav-link active" data-scroll-target="#a-coasean-error">A Coasean Error</a></li>
  <li><a href="#coase-4-lpe" id="toc-coase-4-lpe" class="nav-link" data-scroll-target="#coase-4-lpe">Coase 4 LPE?</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full column-body" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Coase, Invariance, and LPE</h1>
  <div class="quarto-categories">
    <div class="quarto-category">ethics</div>
    <div class="quarto-category">economics</div>
  </div>
  </div>



<div class="quarto-title-meta column-body">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Paul Kelleher </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">December 4, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>There’s an ongoing <a href="https://lpeproject.org/symposia/free-gifts/">symposium on the Law and Political Economy (LPE) Project’s blog</a> on Alyssa Battistoni’s new book <a href="https://press.princeton.edu/books/hardcover/9780691263465/free-gifts?srsltid=AfmBOopoBnoOHxIyKJjYVcAOKfREEU1LqOLlkYC4JYaTSpMieKayw4t4"><em>Free Gifts</em></a>. Both Battistoni’s <a href="https://lpeproject.org/blog/in-the-shadow-of-commodification/">opening piece</a>, as well as Madison Condon’s <a href="https://lpeproject.org/blog/is-climate-change-an-externality/">piece</a>, begin with Ronald Coase’s 1960 paper, <a href="https://www.jstor.org/stable/724810">“The Problem of Social Cost”</a>. This piqued my interest because I recently gave a conference talk about the so-called “Coase Theorem” in which I was trying to correct an error that is common, and that lies at the heart of <a href="https://global.oup.com/academic/product/philosophical-foundations-of-climate-change-policy-9780197567982?cc=us&amp;lang=en&amp;">a recent book</a> about climate change by moral and political philosopher Joseph Heath. Let me quickly state the error, and then return to Battistoni’s discussion.</p>
<section id="a-coasean-error" class="level1 page-columns page-full">
<h1>A Coasean Error</h1>
<p>Restricting the focus to pollution, the Coase Theorem is the <a href="https://www.aeaweb.org/articles?id=10.1257/jel.20191060">conjunction of two propositions</a>:</p>
<ol type="1">
<li><strong><em>Efficiency Claim</em></strong>: In a world with complete markets, well-defined rights, and no transactions costs, the result of bargaining between polluters and pollutees will be Pareto efficient. That is, once bargaining ends, it will not be possible to make one party better off without making another party worse off.</li>
<li><strong><em>Invariance Claim</em></strong>: No matter the initial distribution of rights to pollute and rights to be free from pollution, bargaining of the sort described above will result in the <em>same level</em> of pollution. Give the rights to the polluters (so that pollutees will have to offer bribes to polluters not to pollute), and bargaining will result in <span class="math inline">\(x\)</span> tons of pollution. Give the rights to the pollutees (so that polluters will have to pay a fee in order to pollute) and bargaining will result in <span class="math inline">\(x\)</span> tons of pollution.</li>
</ol>
<p>The Efficiency Claim is not controversial. It’s basically another way of stating the First Fundamental Theorem of Welfare Economics. One can accept it without accepting the logically distinct view that pollution policy ought to aim at Pareto efficient allocations (or to any given efficient allocation), or that the status quo distribution of legal rights to pollute are ethically defensible.</p>
<p>The Invariance Claim, however, is false. It holds only when an individual’s marginal willingness to pay for abatement at any given pollution level does not increase as they become richer. But it is a standard result in environmental economics that environmental quality is a so-called “normal good”—as people become richer, their willingness to pay for a marginal unit of pollution abatement increases (compared, that is, to what they would be willing to pay for the same change in environmental quality if they were poorer).</p>
<p>Regarding this problem for Coase’s Invariance Claim, Steven Medema, probably the world’s leading authority on the Coase Theorem, <a href="https://www.aeaweb.org/articles?id=10.1257/jel.20191060">writes</a>:</p>
<blockquote class="blockquote">
<p>Coase, for his part, later waved aside these objections on the grounds that income effects “will normally be so insignificant that they can be safely neglected,” but “normally” is not sufficient to rescue a “theorem”. (p.&nbsp;1065)</p>
</blockquote>
<p>A very nice 2001 <a href="https://www.emerald.com/books/edited-volume/11417/chapter-abstract/81289939/Climate-rights-and-economic-modeling?redirectedFrom=fulltext">paper</a> by Richard Howarth drives this point home in the context of climate change. Howarth uses an overlapping generations model that is calibrated to the parameters and functional forms of William Nordhaus’s DICE model. Howarth’s model enables one to explore the results of bargaining between different generations when rights to pollute and rights to be free from pollution are allocated in different ways.</p>
<p>Howarth finds that when using Nordhaus’s standard parameterizations, the longrun stock of carbon dioxide in the atmosphere, as well as long run temperature increase, are invariant to the initial distribution of rights. This is Coasean invariance in the wild (or, if you like, in a wild model). Thus, regardless of whether the present generation is endowed with the right to pollute as much as it wants (what Howarth calls the “Pollution rights” scenario), or whether future generations are endowed with the right to be free of all pollution if they want (the “Climate rights” scenario), the amount that each generation will emit after intergenerational bargaining ceases will be the same.</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Howarth1.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">A highlighted partial reproduction of Howarth’s Table 1</figcaption>
</figure>
</div>
<p>However, Coasean invariance disappears when the model is changed to reflect the possibility that climate change will be more harmful than (that vintage of) the DICE model assumed. When the model is programmed to treat a 3 degrees C increase in global mean temperature as being ten times worse for gross world output than the baseline DICE calibration, invariance no longer holds:</p>
<div class="quarto-figure quarto-figure-center page-columns page-full">
<figure class="figure page-columns page-full">
<p><img src="Howarth2.png" class="img-fluid figure-img"></p>
<figcaption class="margin-caption">A highlighted partial reproduction of Howarth’s Table 2</figcaption>
</figure>
</div>
<p>In a “Climate rights” scenario, present-day polluters must pay future pollutees for each ton of CO₂ they wish to emit. Suppose they do this by paying into a trust fund that will offset the damages. The trust fund in turn increases the capital stock, which increases pre-damage future GDP. Higher future GDP means that future generations are wealthier, and since greater wealth leads to a greater valuing of environmental quality, future generations value it more highly in monetary terms. As a result, they charge higher prices to present polluters who would like to buy rights to emit. In Howarth’s “High Damage” setting, these forces conspire to radically lower both the pollution level and temperature increases in the Climate rights scenario as compared to the Pollution rights scenario.</p>
<p>From what I can tell, Coase’s invariance claim is never questioned in Battistoni’s book, and it is not questioned in Heath’s book either. Indeed, invariance underlies Heath’s central claim that one can rely on (Pareto) efficiency considerations alone to determine “whether or not to regulate, and if so how much” (p.&nbsp;202). Howarth’s analysis shows that, in at least some contexts, there is no single pollution level that is “the” efficient level, since the level that would result from frictionless bargaining is in part a function of how rights are initially allocated.</p>
</section>
<section id="coase-4-lpe" class="level1 page-columns page-full">
<h1>Coase 4 LPE?</h1>
<p>I am neither a scholar of law and economics nor a scholar of the progressive competitor discipline of law and political economy (LPE). So I freely admit that I know precious little about the impact Coase’s 1960 paper had on the development of law and economics and on scholars affiliated with it. But this week I’ve read Coase’s paper carefully twice, and I noticed something that I was surprised not to see mentioned in Battistoni’s writing. It is something that seems only very rarely mentioned in the secondary literature on Coase, but which I think is worth flagging and pondering.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<div class="no-row-height column-margin column-container"><div id="fn1"><p><sup>1</sup>&nbsp;An exception is <span class="citation" data-cites="medema2009">Medema (<a href="#ref-medema2009" role="doc-biblioref">2009, p. 118n31</a>)</span>.</p></div></div><p>Relatively early in his paper, Coase writes:</p>
<blockquote class="blockquote">
<p>The economic problem in all cases of harmful effects is how to maximise the value of production. (p.&nbsp;15)</p>
</blockquote>
<p>Coase repeatedly declares that “the economic problem” with externalities is that they consist in a failure to “the value of production”. Virtually always he means that externalities arise because parties cannot enter into mutually advantageous bargains, which in turn means that net benefits for each party are left on the table. Of course, this would not happen in a Coasean paradise in which markets are complete, rights are well-assigned, and bargaining can take place without friction or incomplete knowledge. But we don’t live in that world, and Coase knows it. Indeed, he spends the bulk of his paper asking what should be done when “maximizing value production” cannot be left to the magic of the market either because rights are not well-assigned or well-enforced, or else because of some other impediment to effective bargaining.</p>
<p>It’s in this context that Coase takes aim at Pigou, who (Coase claims) reflexively assumed that rights not to be harmed should be given to pollutees and thus that polluters should be made to pay a fee or fine every time they wished to pollute. Coase says (to paraphrase), “Not so fast.” Given all the imperfections of the real world, it’s at least possible that one could better “maximize the value of production” by legally permitting polluters to pollute. Maybe, for example, it’s much cheaper for pollutees to move than it is for polluters to pay a fee, so that on balance things are better when pollutees must bear the costs of pollution, rather than polluters.</p>
<p>But there’s a subtle shift here. Back when the topic was the Coase theorem, “maximizing the value of production” meant “exhausting mutually beneficial bargains”. In the second part of the paper, however, it takes on a more abstract connotation; there, it involves the general idea of “weighing up the gains that would accrue from eliminating these harmful effects against the gains that accrue from allowing them to continue” (26). And while Coase continues to articulate quantitative examples in this second part in terms of comparing monetary gains with monetary losses, he concludes with this:</p>
<blockquote class="blockquote">
<p>In this article, the analysis has been confined, as is usual in this part of economics, to comparisons of the value of production, as measured by the market. <strong>But it is, of course, desirable that the choice between different social arrangements for the solution of economic problems should be carried out in broader terms than this</strong> and that the total effect of these arrangements in all spheres of life should be taken into account. <strong>As Frank H. Knight has so often emphasized, problems of welfare economics must ultimately dissolve into a study of aesthetics and morals.</strong> (p.&nbsp;43; my emphasis)</p>
</blockquote>
<p>Yet this runs contrary to Battistoni’s suggestion that one of Coase’s complaints about Pigou was that “Pigou had imbued the positive science of economics with normative evaluation” (p.&nbsp;125). And from what I can tell, Battistoni’s reading of Coase is inaccurate. Coase’s complaint was that Pigou was a one-trick policy pony (“Tax, tax, tax!”), not that “Pigou’s analysis relies on an unspoken and unjustified moral framework” (p.&nbsp;127).</p>
<p>In any case, the passage of Coase’s that I quoted just above would seem a perfect one for Battistoni to highlight as she presses her driving concern that:</p>
<blockquote class="blockquote">
<p>The problem comes when the “optimum amount” of pollution and the appropriate level and distribution of social cost are decided largely as a function of value production, under conditions of class and market rule, articulated with other forms of domination … (p.&nbsp;143)</p>
</blockquote>
<p>I’d be interested in how (or whether) her use of Coase’s ideas would change if the passage I’ve flagged were to figure in her discussion.</p>
<p>If the Invariance claim is false; and if the proper approach to externalities in the real world is to evaluate them and their policy responses by “examin[ing] the effects of a proposed policy change and…decid[ing] whether the new situation would be, in total, better or worse than the original one” (p.&nbsp;43); and if this deciding should be responsive to the best ethics rather than to some narrow economic conception of “value production”; then in at least some nearby possible worlds “The Problem of Social Cost” kickstarted a very different intellectual tradition than it did in this world.</p>
<p>Still, it’s not hard to understand why it had the effect it did here, given that certain powerful and vested interests find quite congenial the narrow economic conception of value production that Coase routinely employed. And to be fair, “The Problem of Social Cost” is a long paper that is not much more fun to read than the corresponding chapter in Pigou’s <em>The Economics of Welfare</em>. So at least some readers can be forgiven for not getting to (or not being awake enough to register) Coase’s remark about the essential role of ethics near the very end. But possibly it could be interesting to ponder what might’ve happened if early eagle-eyed readers outside of the Chicago School orbit had stressed and explored that remark in contributions to the field that became law and economics.</p>



</section>


<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="1" role="list">
<div id="ref-medema2009" class="csl-entry" role="listitem">
Medema, S. G. 2009. <em>The Hesitant Hand: Taming Self-Interest in the History of Economic Ideas</em>, Princeton University Press.
</div>
</div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>